//@version=6
indicator("Indian Market Structure & Liquidity", overlay=true, max_labels_count=500, max_lines_count=500)

// ═══════════════════════════════════════════════════════════════════
// INSTITUTIONAL INDIAN MARKET INDICATOR
// Built for: NIFTY | BANKNIFTY | SENSEX | Large-cap stocks
// Philosophy: Structure + Liquidity > Everything Else
// ═══════════════════════════════════════════════════════════════════

// ─────────────────────────────────────────────────────────────────
// INPUT SETTINGS
// ─────────────────────────────────────────────────────────────────
swingLength = input.int(10, "Swing Detection Length", minval=5, maxval=30, 
     tooltip="Higher = Cleaner swings, fewer signals. For Indian markets: 10-15 works best")
displacementThreshold = input.float(0.6, "Displacement Threshold %", minval=0.3, maxval=2.0, step=0.1,
     tooltip="% move required for displacement. Indian markets: 0.5-0.8% is significant")
showLiquidity = input.bool(true, "Show Liquidity Zones")
showBias = input.bool(true, "Show Master Bias")
showStructure = input.bool(true, "Show Structure Lines")

// ─────────────────────────────────────────────────────────────────
// MODULE 1: STRUCTURE ENGINE (SLOW & CLEAN)
// ─────────────────────────────────────────────────────────────────

// Detect CONFIRMED swing highs and lows
// These are NOT micro-swings - these are structure pivots
isSwingHigh = ta.pivothigh(high, swingLength, swingLength)
isSwingLow = ta.pivotlow(low, swingLength, swingLength)

// Store structure state
var float lastSwingHigh = na
var float lastSwingLow = na
var int lastSwingHighBar = na
var int lastSwingLowBar = na
var int currentStructureCode = 0 // 1=BULLISH, -1=BEARISH, 0=RANGE

// Update swing points only when CONFIRMED
if not na(isSwingHigh)
    lastSwingHigh := high[swingLength]
    lastSwingHighBar := bar_index - swingLength
    
if not na(isSwingLow)
    lastSwingLow := low[swingLength]
    lastSwingLowBar := bar_index - swingLength

// Draw structure lines (clean, minimal)
if showStructure and not na(lastSwingHigh) and not na(lastSwingLow)
    if lastSwingHighBar > lastSwingLowBar
        line.new(lastSwingHighBar, lastSwingHigh, bar_index, lastSwingHigh, 
             color=color.new(color.red, 70), width=1, style=line.style_dashed)
    else
        line.new(lastSwingLowBar, lastSwingLow, bar_index, lastSwingLow, 
             color=color.new(color.green, 70), width=1, style=line.style_dashed)

// ─────────────────────────────────────────────────────────────────
// MODULE 2: LIQUIDITY ZONES (INDIAN MARKET STYLE)
// ─────────────────────────────────────────────────────────────────

// Get prior day high/low
var float pdHigh = na
var float pdLow = na
if ta.change(time('D')) != 0
    pdHigh := high[1]
    pdLow := low[1]

// Get weekly high/low
var float pwHigh = na
var float pwLow = na
if ta.change(time('W')) != 0
    pwHigh := high[1]
    pwLow := low[1]

// Psychological round levels (Indian market loves these)
roundLevel = math.round(close / 100) * 100

// Draw liquidity zones
if showLiquidity
    // Prior Day High/Low
    if not na(pdHigh)
        line.new(bar_index - 1, pdHigh, bar_index, pdHigh, 
             color=color.new(#ff6b6b, 80), width=1, extend=extend.right, style=line.style_dotted)
    if not na(pdLow)
        line.new(bar_index - 1, pdLow, bar_index, pdLow, 
             color=color.new(#51cf66, 80), width=1, extend=extend.right, style=line.style_dotted)

// Detect liquidity events
var string lastLiqEvent = na
liquidityProbe = false
liquidityTrap = false

// PROBE: Price tests liquidity but respects it
if not na(pdHigh) and high >= pdHigh and close < pdHigh - (high - low) * 0.5
    liquidityProbe := true
    lastLiqEvent := "probe_high"
    
if not na(pdLow) and low <= pdLow and close > pdLow + (high - low) * 0.5
    liquidityProbe := true
    lastLiqEvent := "probe_low"

// TRAP: Price violates liquidity then reverses sharply
if not na(pdHigh) and high > pdHigh and close < pdHigh and (high - close) > (high - low) * 0.6
    liquidityTrap := true
    if showLiquidity
        label.new(bar_index, high, "TRAP\nSellers above PDH", 
             style=label.style_label_down, color=color.new(#ff6b6b, 20), 
             textcolor=color.white, size=size.small)

if not na(pdLow) and low < pdLow and close > pdLow and (close - low) > (high - low) * 0.6
    liquidityTrap := true
    if showLiquidity
        label.new(bar_index, low, "TRAP\nBuyers below PDL", 
             style=label.style_label_up, color=color.new(#51cf66, 20), 
             textcolor=color.white, size=size.small)

// Mark liquidity probes (just dots, no noise)
plotshape(liquidityProbe and not liquidityTrap, "Liquidity Probe", 
     shape.circle, location.absolute, color.new(color.orange, 50), size=size.tiny)

// ─────────────────────────────────────────────────────────────────
// MODULE 3: CHoCH (VERY RARE & STRICT)
// ─────────────────────────────────────────────────────────────────

// Pre-calculate volume SMA for consistency
volumeSMA = ta.sma(volume, 20)

var bool chochDetected = false
var int chochTypeCode = 0  // 1=BULLISH, -1=BEARISH, 0=NONE
chochDetected := false
chochTypeCode := 0

// CHoCH logic: Structure must TRULY break
// Not just any swing break - must be PROTECTED swing with follow-through

if currentStructureCode == 1  // BULLISH
    // Bearish CHoCH: Break last swing low with conviction
    if not na(lastSwingLow) and close < lastSwingLow
        // Check for displacement confirmation
        barRange = high - low
        moveSize = math.abs(close - open)
        if moveSize > barRange * 0.6 and volume > volumeSMA * 1.2
            chochDetected := true
            chochTypeCode := -1
            currentStructureCode := -1
            
else if currentStructureCode == -1  // BEARISH
    // Bullish CHoCH: Break last swing high with conviction
    if not na(lastSwingHigh) and close > lastSwingHigh
        // Check for displacement confirmation
        barRange = high - low
        moveSize = math.abs(close - open)
        if moveSize > barRange * 0.6 and volume > volumeSMA * 1.2
            chochDetected := true
            chochTypeCode := 1
            currentStructureCode := 1
else  // RANGE
    // From RANGE: Need strong conviction
    if not na(lastSwingHigh) and close > lastSwingHigh * 1.005
        currentStructureCode := 1
        chochDetected := true
        chochTypeCode := 1
    else if not na(lastSwingLow) and close < lastSwingLow * 0.995
        currentStructureCode := -1
        chochDetected := true
        chochTypeCode := -1

// Mark CHoCH (RARE events only)
if chochDetected and chochTypeCode == 1
    label.new(bar_index, low, "CHoCH ↑\nStructure shifts bullish", 
         style=label.style_label_up, color=color.new(#51cf66, 10), 
         textcolor=color.white, size=size.normal)
    line.new(bar_index, low, bar_index, high, color=color.green, width=2)

if chochDetected and chochTypeCode == -1
    label.new(bar_index, high, "CHoCH ↓\nStructure shifts bearish", 
         style=label.style_label_down, color=color.new(#ff6b6b, 10), 
         textcolor=color.white, size=size.normal)
    line.new(bar_index, low, bar_index, high, color=color.red, width=2)

// ─────────────────────────────────────────────────────────────────
// MODULE 4: DISPLACEMENT (EXPIRY-AWARE)
// ─────────────────────────────────────────────────────────────────

// Pre-calculate average range for consistency
avgRange = ta.sma(high - low, 20)

// Displacement = Range-expanding move with intent
priceRange = high - low
movePercent = (priceRange / close) * 100

// Displacement criteria (strict for Indian markets)
isDisplacement = false
if movePercent > displacementThreshold and priceRange > avgRange * 1.5
    // Check if near liquidity zone (makes it meaningful)
    nearLiquidity = false
    if not na(pdHigh) and math.abs(high - pdHigh) < avgRange * 0.5
        nearLiquidity := true
    if not na(pdLow) and math.abs(low - pdLow) < avgRange * 0.5
        nearLiquidity := true
    if not na(pwHigh) and math.abs(high - pwHigh) < avgRange
        nearLiquidity := true
    if not na(pwLow) and math.abs(low - pwLow) < avgRange
        nearLiquidity := true
    
    if nearLiquidity
        isDisplacement := true

// Mark displacement
bgcolor(isDisplacement ? (close > open ? color.new(color.green, 90) : color.new(color.red, 90)) : na,
     title="Displacement Background")

// ─────────────────────────────────────────────────────────────────
// MODULE 5: MASTER BIAS ENGINE
// ─────────────────────────────────────────────────────────────────

var int masterBiasCode = 0  // 1=BULLISH, -1=BEARISH, 0=RANGE
var color biasColor = color.gray
var string masterBiasText = "RANGE"

// Bias changes SLOWLY - this is critical for Indian markets
// Check every 5 bars to avoid noise
if bar_index % 5 == 0
    bullishPoints = 0
    bearishPoints = 0
    
    // Structure alignment
    if not na(lastSwingHigh) and not na(lastSwingLow)
        if lastSwingHighBar > lastSwingLowBar and close > lastSwingLow
            bullishPoints += 2
        else if lastSwingLowBar > lastSwingHighBar and close < lastSwingHigh
            bearishPoints += 2
    
    // Price position relative to liquidity
    if not na(pdHigh) and not na(pdLow)
        pricePosition = (close - pdLow) / (pdHigh - pdLow)
        if pricePosition > 0.7
            bullishPoints += 1
        else if pricePosition < 0.3
            bearishPoints += 1
    
    // Recent displacement direction
    if isDisplacement
        if close > open
            bullishPoints += 1
        else
            bearishPoints += 1
    
    // Update bias (needs clear majority)
    if bullishPoints >= 3 and bullishPoints > bearishPoints
        masterBiasCode := 1
        masterBiasText := "BULLISH"
        biasColor := color.new(color.green, 70)
    else if bearishPoints >= 3 and bearishPoints > bullishPoints
        masterBiasCode := -1
        masterBiasText := "BEARISH"
        biasColor := color.new(color.red, 70)
    else
        masterBiasCode := 0
        masterBiasText := "RANGE"
        biasColor := color.new(color.gray, 80)

// Display Master Bias
if showBias
    var table biasTable = table.new(position.top_right, 1, 1)
    table.cell(biasTable, 0, 0, "BIAS: " + masterBiasText, 
         bgcolor=biasColor, text_color=color.white, text_size=size.large)

// Background tint for bias (very subtle)
bgcolor(showBias ? biasColor : na, title="Bias Background")

// ─────────────────────────────────────────────────────────────────
// ALERTS
// ─────────────────────────────────────────────────────────────────

alertcondition(chochDetected, "CHoCH Detected", "Structure Change Detected - Check liquidity context")
alertcondition(liquidityTrap, "Liquidity Trap", "Liquidity trap detected - Potential reversal")
alertcondition(ta.change(masterBiasCode) != 0, "Bias Change", "Master bias has changed")

// ═══════════════════════════════════════════════════════════════════
// INDIAN MARKET TRADING PHILOSOPHY (CRITICAL READING)
// ═══════════════════════════════════════════════════════════════════
//
// This indicator is built on REALITY, not theory.
//
// 1. INDIAN MARKETS ARE EXPIRY-DRIVEN
//    • Weekly expiries create artificial pressure
//    • Thursday expiries (Nifty/BankNifty) behave differently
//    • Max pain theory is REAL in Indian options
//    • Structure matters LESS on expiry day, liquidity matters MORE
//
// 2. MOVES ARE SLOWER BUT MORE DECISIVE
//    • Unlike crypto, intraday moves are contained
//    • When structure breaks, it stays broken for DAYS
//    • Don't expect 5 CHoCH in a day - expect 1 per week
//    • Patience = Edge
//
// 3. LIQUIDITY TRAPS ARE THE TRADE
//    • Prior day high/low are magnets
//    • Round numbers (18000, 44000) are defended
//    • Banks/FIIs defend option strikes aggressively
//    • Best trades = Fade liquidity hunts
//
// 4. WHY NO EMA/RSI/MACD?
//    • These lag in expiry-driven moves
//    • Structure + Liquidity > Indicators
//    • Context beats signals
//
// 5. WHEN TO TRADE (HONEST TRUTH)
//    • ✅ Clear CHoCH + Displacement
//    • ✅ Liquidity trap confirmed by price action
//    • ✅ Bias aligned with structure
//    • ❌ Choppy consolidation
//    • ❌ News days before confirmation
//    • ❌ Last 30 mins of expiry (chaos)
//
// 6. NO TRADE IS A POSITION
//    • If chart looks messy → indicator shows RANGE → WAIT
//    • Better to miss a move than force a trade
//    • Indian markets reward patience, punish greed
//
// 7. EXPIRY DAY BEHAVIOR
//    • Structure breaks mean LESS
//    • Focus on strikes being defended
//    • Avoid directional trades after 2 PM
//    • Let market settle, trade next day
//
// 8. POSITION SIZING REALITY
//    • Structure trades = Normal size
//    • Liquidity traps = Half size (can be violent)
//    • Expiry day = Quarter size or avoid
//
// 9. WHAT THIS INDICATOR WILL NOT DO
//    • Give you 10 signals a day
//    • Make every candle tradeable
//    • Work on 1-minute charts
//    • Predict news events
//
// 10. WHAT THIS INDICATOR DOES BEST
//    • Shows TRUE structure (not noise)
//    • Marks liquidity zones that matter
//    • Identifies rare CHoCH moments
//    • Keeps you OUT of bad trades
//
// Remember: In Indian markets, the best traders are the most patient.
// This indicator helps you wait for YOUR trades, not chase every move.
//
// ═══════════════════════════════════════════════════════════════════
